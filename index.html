<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Quiz</title>
  <style>
    body {
      font-size: 18px;
    }

    .quiz-button {
      display: inline-block;
      vertical-align: middle;
    }

    .quiz-button img {
      width: 110px;
      height: 110px;
    }
  </style>
</head>
<body>
  <h1>Quiz</h1>
  <script src="questions2.js"></script>

  <!-- Exam Type Selection -->
  <div id="exam-selection">
    <div>
      <button onclick="selectExamType(1)" class="quiz-button">
        <div><img src="H2/type1.png"></div>
        <div><span id="avg-type-1"></span></div>
      </button>
      <button onclick="selectExamType(2)" class="quiz-button">
        <div><img src="H2/type2.png"></div>
        <div><span id="avg-type-2"></span></div>
      </button>
    </div>
    <div>
      <button onclick="selectExamType(3)" class="quiz-button">
        <div><img src="H2/type3.png"></div>
        <div><span id="avg-type-3"></span></div>
      </button>
      <button onclick="selectExamType(4)" class="quiz-button">
        <div><img src="H2/type4.png"></div>
        <div><span id="avg-type-4"></span></div>
      </button>
      <button onclick="selectExamType(5)" class="quiz-button">
        <div><img src="H2/type5.png"></div>
        <div><span id="avg-type-5"></span></div>
      </button>
    </div>
    <div>
      <button onclick="selectExamType(6)" class="quiz-button">
        <div><img src="H2/type6.png"></div>
        <div><span id="avg-type-6"></span></div>
      </button>
      <button onclick="selectExamType(7)" class="quiz-button">
        <div><img src="H2/type7.png"></div>
        <div><span id="avg-type-7"></span></div>
      </button>
      <button onclick="selectExamType(8)" class="quiz-button">
        <div><img src="H2/type8.png"></div>
        <div><span id="avg-type-8"></span></div>
      </button>
    </div>
  </div>

  <!-- Quiz Container -->
  <div id="quiz-container" style="display: none;">
    <p id="qz_question_number"></p>
    <p id="question_number"></p>
    <p id="question"></p>
    <img id="image" style="display: none;">
    <ul id="answers"></ul>
    <button id="submit-answer">Submit Answer</button>
    <p id="result"></p>
    <button id="next-question" style="display: none;">Next Question</button>
  </div>

  <!-- Grade Container -->
  <p id="grade" style="display: none;"></p>

  <!-- Questions Container -->
  <div id="questions-container">
    <h2>Questions</h2>
    <ul id="questions-list"></ul>
  </div>

  <!-- Quiz Script -->
  <script>
    // Initialize variables
    let currentQuestion = 0;
    let score = 0;
    let quiz_length = 25;
    let images_folder = "H2";
    let questions_file = "questions2.js";

    const examTypes = [
      { type: 1, name: "אימון מתקדם", range: [1, 240] },
      { type: 2, name: "מבחן רגיל", range: [1, 240] },
      { type: 3, name: "מערכת הורמונלית", range: [1, 28] },
      { type: 4, name: "לב כלי דם", range: [29, 81] },
      { type: 5, name: "מערכת הנשימה", range: [82, 113] },
      { type: 6, name: "מערכת העיקול", range: [114, 153] },
      { type: 7, name: "מערכת המין", range: [154, 192] },
      { type: 8, name: "מערכת החיסון", range: [193, 240] },
    ];
    let selectedType = examTypes[0];  // Default to the first type

    //let QSTATS = JSON.parse(localStorage.getItem('QSTATS')) || questions.map(q => q.QSTAT);

    QSTATS = JSON.parse(localStorage.getItem('QSTATS')) || QSTATS;
    for(var i = 0; i < QSTATS.length; i++) {
      if(QSTATS[i] != null) {
        QSTATS[i] = Number(QSTATS[i].toFixed(1));
      }
    }

    localStorage.setItem('QSTATS', JSON.stringify(QSTATS));

    //displayQSTATS();

    function selectExamType(type) {
      selectedType = examTypes.find(t => t.type === type);
      shuffleQuestions();
      startQuiz();
    }

    // Shuffle the answers in the question
    function shuffle_answers(question) {
      // Check if answer 4 exists and meets the conditions
      if (question.answers.length > 3 && question.answers[3].indexOf("תשוב") === -1 && question.answers[3] !== "") {
        // Shuffle the answers using the Fisher-Yates shuffle algorithm
        for (var i = question.answers.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var temp = question.answers[i];
          question.answers[i] = question.answers[j];
          question.answers[j] = temp;
          if (i === question.correctAnswer) {
            question.correctAnswer = j;
          }
          else if (j === question.correctAnswer) {
            question.correctAnswer = i;
          }
        }
      }
    }

    function shuffleQuestions() {
      questions = questions.slice(selectedType.range[0] - 1, selectedType.range[1]);

      if (selectedType.name === "training") {
        let lowestQSTATIndices = QSTATS.map((q, i) => [q, i]).sort((a, b) => a[0] - b[0]).slice(0, 15).map(q => q[1]);
        let otherIndices = Array.from({ length: questions.length }, (_, i) => i).filter(i => !lowestQSTATIndices.includes(i));
        shuffleArray(otherIndices);
        otherIndices = otherIndices.slice(0, 10);
        questions = lowestQSTATIndices.concat(otherIndices).map(i => questions[i]);
      }

      shuffleArray(questions);
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
        //shuffle_answers(array[i]);
      }
    }

    function startQuiz() {
      document.getElementById("exam-selection").style.display = "none";
      document.getElementById("quiz-container").style.display = "block";
      displayQuestion();
    }

    function displayQuestion() {
      let question = questions[currentQuestion];
      document.getElementById("qz_question_number").innerHTML = "Question " + (currentQuestion + 1) + " of " + quiz_length;
      document.getElementById("question_number").innerHTML = "שאלה " + question.question_number;
      document.getElementById("question").innerHTML = question.question;
      document.getElementById("answers").innerHTML = "";

      let image = new Image();
      let len = question.question_number.length;
      let image_path = images_folder + "/i" + parseInt(question.question_number.substring(0, 3)) + ".png";
      image.onerror = function () {
        document.getElementById("image").style.display = "none";
      }
      image.onload = function () {
        document.getElementById("image").src = image_path;
        document.getElementById("image").style.display = "block";
      }
      image.src = image_path;

      for (let i = 0; i < question.answers.length; i++) {
        if (question.answers[i].length > 0)
          document.getElementById("answers").innerHTML += "<li><input type='radio' name='answer' value='" + i + "'>" + question.answers[i] + "</li>";
      }
    }

    document.getElementById("submit-answer").addEventListener("click", function () {
      let userAnswer = document.querySelector("input[name='answer']:checked").value;
      let question = questions[currentQuestion];
      let questionNumber = parseInt(question.question_number.substring(0, 3));
      if (question.correctAnswer == -1) {
        question.correctAnswer = question.answerAI;
      }
      if (userAnswer == question.correctAnswer) {
        document.getElementById("result").innerHTML = "Correct!";
        score++;
        if (QSTATS[questionNumber] == null) {
          QSTATS[questionNumber] = 100;
        }
        else {
          QSTATS[questionNumber] = QSTATS[questionNumber] * 0.7 + 30;
          QSTATS[questionNumber] = Number(QSTATS[questionNumber].toFixed(1));
        }
      } else {
        document.getElementById("result").innerHTML = "Incorrect! The correct answer is " + question.answers[question.correctAnswer];
        if (QSTATS[questionNumber] == null) {
          QSTATS[questionNumber] = 0;
        }
        else {
          QSTATS[questionNumber] = QSTATS[questionNumber] * 0.7;
          QSTATS[questionNumber] = Number(QSTATS[questionNumber].toFixed(1));
        }
      }
      localStorage.setItem('QSTATS', JSON.stringify(QSTATS));
      document.getElementById("submit-answer").style.display = "none";
      document.getElementById("next-question").style.display = "block";
    });

    document.getElementById("next-question").addEventListener("click", function () {
      currentQuestion++;
      if (currentQuestion == quiz_length) {
        document.getElementById("quiz-container").style.display = "none";
        document.getElementById("grade").innerHTML = "Score: " + score + "/" + currentQuestion + " - Final Grade: " + (score / quiz_length * 100).toFixed(0);//questions.length
        document.getElementById("grade").style.display = "block";
        sendEmail();
        displayAverageQSTAT(examTypes[0].range);
      } else {
        displayQuestion();
        document.getElementById("result").innerHTML = "";
        document.getElementById("submit-answer").style.display = "block";
        document.getElementById("next-question").style.display = "none";
      }
    });

    function sendEmail() {
      // Implement your email sending code here...
    }

    function displayAverageQSTAT(range) {
      let qstatsInRange = QSTATS.slice(range[0] - 1, range[1]);
      var filteredQSTATS = qstatsInRange.filter(function(value) {
        return value != null;
      });
      let avg = filteredQSTATS.reduce((a, b) => a + b, 0) / filteredQSTATS.length;
      document.getElementById("grade").innerHTML += "<br>Average QSTAT for this exam type: " + avg.toFixed(1);
    }

    function displayAverageQSTATs() {
      examTypes.forEach((type) => {
        let qstatsInRange = QSTATS.slice(type.range[0] - 1, type.range[1]);
        var filteredQSTATS = qstatsInRange.filter(function(value) {
          return value != null;
        });
        let avg = filteredQSTATS.reduce((a, b) => a + b, 0) / filteredQSTATS.length;
        document.getElementById("avg-type-" + type.type).textContent = " " + type.name + " " + avg.toFixed(1);
      });
    }

    function displayQSTATS() {
      let output = "<p>";
      for(let i = 0; i < QSTATS.length; i++) {
        output += i + ":" + QSTATS[i] + " ";
        if ((i + 1) % 20 === 0) {
          output += "</p><p>";
        }
      }
      output += "</p>";
      document.body.insertAdjacentHTML('afterbegin', output);
    }

    displayAverageQSTATs();
  </script>
</body>

<form id="answers-form">
  <div class="answers-form"></div>
  <button type="submit">Submit Answers</button>
</form>

</html>
