<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Quiz</title>
  <style>
    body {
      font-size: 18px;
    }

    .quiz-button {
      display: inline-block;
      vertical-align: middle;
    }

    .quiz-button img {
      width: 120px;
      height: 100px;
    }
  </style>
</head>
<body>
  <h1>Quiz</h1>
  <script src="questions2.js"></script>

  <!-- Exam Type Selection -->
  <div id="exam-selection">
    <div>
      <button onclick="selectExamType(1)" class="quiz-button">
        <div><img src="H2/type1.png"></div>
        <div><span id="type-1"></span></div>
        <div><span id="avg-grade-1" style="font-size: 33px;"></span></div>
      </button>
      <button onclick="selectExamType(2)" class="quiz-button">
        <div><img src="H2/type2.png"></div>
        <div><span id="type-2"></span></div>
        <div><span id="avg-grade-2" style="font-size: 33px;"></span></div>
      </button>
      <button onclick="selectExamType(3)" class="quiz-button">
        <div><img src="H2/easy.png"></div>
        <div><span id="type-3"></span></div>
        <div><span id="avg-grade-3" style="font-size: 33px;"></span></div>
      </button>
    </div>
    <div>
      <button onclick="selectExamType(4)" class="quiz-button">
        <div><img src="H2/type3.png"></div>
        <div><span id="type-4"></span></div>
        <div><span id="avg-grade-4" style="font-size: 27px;"></span></div>
      </button>
      <button onclick="selectExamType(5)" class="quiz-button">
        <div><img src="H2/type4.png"></div>
        <div><span id="type-5"></span></div>
        <div><span id="avg-grade-5" style="font-size: 27px;"></span></div>
      </button>
      <button onclick="selectExamType(6)" class="quiz-button">
        <div><img src="H2/type5.png"></div>
        <div><span id="type-6"></span></div>
        <div><span id="avg-grade-6" style="font-size: 27px;"></span></div>
      </button>
    </div>
    <div>
      <button onclick="selectExamType(7)" class="quiz-button">
        <div><img src="H2/type6.png"></div>
        <div><span id="type-7"></span></div>
        <div><span id="avg-grade-7" style="font-size: 27px;"></span></div>
      </button>
      <button onclick="selectExamType(8)" class="quiz-button">
        <div><img src="H2/type7.png"></div>
        <div><span id="type-8"></span></div>
        <div><span id="avg-grade-8" style="font-size: 27px;"></span></div>
      </button>
      <button onclick="selectExamType(9)" class="quiz-button">
        <div><img src="H2/type8.png"></div>
        <div><span id="type-9"></span></div>
        <div><span id="avg-grade-9" style="font-size: 27px;"></span></div>
      </button>
    </div>
  </div>

  <!-- Quiz Container -->
  <div id="quiz-container" style="display: none;">
    <p id="qz_question_number"></p>
    <p id="question_number"></p>
    <p id="question"></p>
    <img id="image" style="display: none;">
    <ul id="answers"></ul>
    <button id="submit-answer">Submit Answer</button>
    <p id="result"></p>
    <button id="next-question" style="display: none;">Next Question</button>
  </div>

  <!-- Grade Container -->
  <p id="grade" style="display: none;"></p>

  <!-- Questions Container -->
  <div id="questions-container">
    <h2 style="font-size: 17px;">Questions</h2>
    <ul id="questions-list"></ul>
  </div>

  <!-- Quiz Script -->
  <script>
    // Initialize variables
    let currentQuestion = 0;
    let score = 0;
    let quiz_length = 25;
    let images_folder = "H2";
    let questions_file = "questions2.js";

    const examTypes = [
      { type: 1, name: "מבחן מאתגר (מומלץ)", range: [1, 240] },
      { type: 2, name: "צפי לציון במבחן אמיתי", range: [1, 240] },
      { type: 3, name: "מבחן קליל", range: [1, 240] },
      { type: 4, name: "המערכת ההורמונלית", range: [1, 28] },
      { type: 5, name: "לב, כלי הדם ולימפה", range: [29, 81] },
      { type: 6, name: "מערכת הנשימה", range: [82, 113] },
      { type: 7, name: "מערכת העיקול", range: [114, 153] },
      { type: 8, name: "מערכות המין והרבייה", range: [154, 192] },
      { type: 9, name: "מערכות החיסון והפרשה", range: [193, 240] },
    ];
    let selectedType = examTypes[0];  // Default to the first type

    // Define hardcoded version
    const hardcodedVersion = '1.0.0';

    // Get version from localStorage
    let savedVersion = localStorage.getItem('version');

    // Check if saved version is different from hardcoded version
    if (savedVersion !== hardcodedVersion) {
      // If it's the same, get QSTATS from localStorage
      QSTATS = JSON.parse(localStorage.getItem('QSTATS')) || QSTATS;
      QSTATS[11] = 0;
      QSTATS[53] = 0;
      QSTATS[67] = 0;
      QSTATS[138] = 0;
      QSTATS[171] = 0;
      QSTATS[174] = 0;

      QSTATS[143] = 0;
      QSTATS[154] = 0;
      QSTATS[157] = 0;
      QSTATS[169] = 0;
      QSTATS[172] = 0;
      QSTATS[176] = 0;
      QSTATS[182] = 0;
      QSTATS[185] = 0;
      QSTATS[186] = 0;
      QSTATS[187] = 0;
      QSTATS[192] = 0;
      QSTATS[194] = 0;
      QSTATS[207] = 0;
      QSTATS[212] = 0;
      QSTATS[213] = 0;
      QSTATS[217] = 0;
      QSTATS[218] = 0;
      QSTATS[221] = 0;
      QSTATS[222] = 0;
      QSTATS[227] = 0;
      QSTATS[232] = 0;
      QSTATS[233] = 0;
      QSTATS[238] = 0;
      QSTATS[239] = 0;
      QSTATS[240] = 0;

      // If it's different, update localStorage with new version and new QSTATS
      localStorage.setItem('version', hardcodedVersion);
      localStorage.setItem('QSTATS', JSON.stringify(QSTATS));
    } else {
      // If it's the same, get QSTATS from localStorage
      QSTATS = JSON.parse(localStorage.getItem('QSTATS')) || QSTATS;
    }

    displayQSTATS();

    function selectExamType(type) {
      selectedType = examTypes.find(t => t.type === type);
      shuffleQuestions();
      startQuiz();
    }

    // Shuffle the answers in the question
    function shuffle_answers(question) {
      // Check if answer 4 exists and meets the conditions
      if (question.answers.length > 3 && question.answers[3].indexOf("תשוב") === -1 && question.answers[3] !== "") {
        // Shuffle the answers using the Fisher-Yates shuffle algorithm
        for (var i = question.answers.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var temp = question.answers[i];
          question.answers[i] = question.answers[j];
          question.answers[j] = temp;
          if (i === question.correctAnswer) {
            question.correctAnswer = j;
          }
          else if (j === question.correctAnswer) {
            question.correctAnswer = i;
          }
        }
      }
    }

    function shuffleQuestions() {
      questions = questions.slice(selectedType.range[0] - 1, selectedType.range[1]);

      //if (selectedType.type === 1 || selectedType.type >= 4) {
      if (selectedType.type === 1) {
        let lowestQSTATIndices = QSTATS.map((q, i) => [q, i]).sort((a, b) => a[0] - b[0]).slice(0, 15).map(q => q[1]);
        let otherIndices = Array.from({ length: questions.length }, (_, i) => i).filter(i => !lowestQSTATIndices.includes(i));
        shuffleArray(otherIndices);
        otherIndices = otherIndices.slice(0, 10);
        questions = lowestQSTATIndices.concat(otherIndices).map(i => questions[i]);
      }
      else if (selectedType.type === 3) {
        let highestQSTATIndices = QSTATS.map((q, i) => [q, i]).sort((a, b) => b[0] - a[0]).slice(0, 15).map(q => q[1]);
        let otherIndices = Array.from({ length: questions.length }, (_, i) => i).filter(i => !highestQSTATIndices.includes(i));
        shuffleArray(otherIndices);
        otherIndices = otherIndices.slice(0, 10);
        questions = highestQSTATIndices.concat(otherIndices).map(i => questions[i]);
      }

      shuffleArray(questions);
    }


    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
        //shuffle_answers(array[i]);
      }
    }

    function startQuiz() {
      document.getElementById("exam-selection").style.display = "none";
      document.getElementById("quiz-container").style.display = "block";
      displayQuestion();
    }

    function displayQuestion() {
      let question = questions[currentQuestion];
      document.getElementById("qz_question_number").innerHTML = "Question " + (currentQuestion + 1) + " of " + quiz_length;
      document.getElementById("question_number").innerHTML = "שאלה " + question.question_number;
      document.getElementById("question").innerHTML = question.question;
      document.getElementById("answers").innerHTML = "";

      let image = new Image();
      let len = question.question_number.length;
      let image_path = images_folder + "/i" + parseInt(question.question_number.substring(0, 3)) + ".png";
      image.onerror = function () {
        document.getElementById("image").style.display = "none";
      }
      image.onload = function () {
        document.getElementById("image").src = image_path;
        document.getElementById("image").style.display = "block";
      }
      image.src = image_path;

      for (let i = 0; i < question.answers.length; i++) {
        if (question.answers[i].length > 0)
          document.getElementById("answers").innerHTML += "<li><input type='radio' name='answer' value='" + i + "'>" + question.answers[i] + "</li>";
      }
    }

    document.getElementById("submit-answer").addEventListener("click", function () {
      let userAnswer = document.querySelector("input[name='answer']:checked").value;
      let question = questions[currentQuestion];
      let questionNumber = parseInt(question.question_number.substring(0, 3));
      if (question.correctAnswer == -1) {
        question.correctAnswer = question.answerAI;
      }
      if (userAnswer == question.correctAnswer) {
        document.getElementById("result").innerHTML = "Correct!";
        score++;
        if (QSTATS[questionNumber] == 0) {
          QSTATS[questionNumber] = 92;
        }
        else {
          QSTATS[questionNumber] = QSTATS[questionNumber] * 0.5 + 50;
          QSTATS[questionNumber] = Number(QSTATS[questionNumber].toFixed(1));
        }
      } else {
        document.getElementById("result").innerHTML = "Incorrect! The correct answer is " + question.answers[question.correctAnswer];
        if (QSTATS[questionNumber] == 0) {
          QSTATS[questionNumber] = 25;
        }
        else {
          QSTATS[questionNumber] = QSTATS[questionNumber] * 0.5;
          QSTATS[questionNumber] = Number(QSTATS[questionNumber].toFixed(1));
        }
      }
      localStorage.setItem('QSTATS', JSON.stringify(QSTATS));
      document.getElementById("submit-answer").style.display = "none";
      document.getElementById("next-question").style.display = "block";
    });

    document.getElementById("next-question").addEventListener("click", function () {
      currentQuestion++;
      if (currentQuestion == quiz_length) {
        document.getElementById("quiz-container").style.display = "none";
        document.getElementById("grade").innerHTML = "Score: " + score + "/" + currentQuestion + " - Final Grade: " + (score / quiz_length * 100).toFixed(0);//questions.length
        document.getElementById("grade").style.display = "block";
        sendEmail();
        reduceAllQstats();
      } else {
        displayQuestion();
        document.getElementById("result").innerHTML = "";
        document.getElementById("submit-answer").style.display = "block";
        document.getElementById("next-question").style.display = "none";
      }
      questionAnswered();
    });

    function sendEmail() {
      // Implement your email sending code here...
    }


    function displayAverageQSTATs() {
      examTypes.forEach((type) => {
        let qstatsInRange = QSTATS.slice(type.range[0] - 1, type.range[1]);
        var filteredQSTATS = qstatsInRange.filter(function(value) {
          return value != null && value != 0;
        });
        let avg = filteredQSTATS.reduce((a, b) => a + b, 0) / filteredQSTATS.length;
        if (type.type == 1) {
            avg = (3*avg - 100)/2;
        }
        else if (type.type == 3) {
            avg = (avg + 100)/2;
        }
        document.getElementById("type-" + type.type).textContent = " " + type.name;
        document.getElementById("avg-grade-" + type.type).textContent = " " + avg.toFixed(1);
      });
    }

    function displayQSTATS() {
      //let output = "<p>";
      //for(let i = 1; i <= QSTATS.length; i++) {
      //let paddedI = String(i).padStart(3, '0');
      //let paddedQSTATS = QSTATS[i] === 0 ? '--' : String(QSTATS[i]).padStart(2, '0');
      //output += paddedI + ":" + paddedQSTATS + " ";
      //if (i % 30 === 0 && i != 0) {
      //    output += "</p><p>";
      //  }
      //}
      //output += "</p>";
      //document.body.insertAdjacentHTML('afterbegin', output);

      // Get the total questions answered and total questions answered today from local storage
      let totalQuestionsAnswered = localStorage.getItem('totalQuestionsAnswered') || 0;
      let totalQuestionsAnsweredToday = localStorage.getItem('totalQuestionsAnsweredToday') || 0;

      // Display the counts
      let questionsContainer = document.getElementById('questions-container');
      let h2 = questionsContainer.querySelector('h2');
      h2.textContent = `Questions answered today: ${totalQuestionsAnsweredToday} in total: ${totalQuestionsAnswered}`;

      // Other QSTATS displaying code goes here...
    }

    function reduceAllQstats() {
      for(let i = 1; i < QSTATS.length; i++) {
        if(QSTATS[i] > 5) {
           QSTATS[i] = QSTATS[i] - 0.1;
        }
      }
      localStorage.setItem('QSTATS', JSON.stringify(QSTATS));
    }

    function questionAnswered() {
      // Increment the total questions answered and total questions answered today
      let totalQuestionsAnswered = Number(localStorage.getItem('totalQuestionsAnswered')) || 0;
      let totalQuestionsAnsweredToday = Number(localStorage.getItem('totalQuestionsAnsweredToday')) || 0;
      totalQuestionsAnswered++;
      totalQuestionsAnsweredToday++;

      // Save the updated counts to local storage
      localStorage.setItem('totalQuestionsAnswered', totalQuestionsAnswered);
      localStorage.setItem('totalQuestionsAnsweredToday', totalQuestionsAnsweredToday);

      // Other question answered logic goes here...
      // At the end of your questionAnswered function...
      let currentDate = new Date().toISOString().slice(0,10); // Get the current date as YYYY-MM-DD
      localStorage.setItem('lastAnsweredDate', currentDate);

      // When the page is loaded...
      let lastAnsweredDate = localStorage.getItem('lastAnsweredDate') || '';
      currentDate = new Date().toISOString().slice(0,10); // Get the current date as YYYY-MM-DD
      if (currentDate !== lastAnsweredDate) {
        // If the current date does not match the date when the user last answered a question, reset the count
        localStorage.setItem('totalQuestionsAnsweredToday', 0);
      }
    }

    displayAverageQSTATs();
  </script>
</body>

<form id="answers-form">
  <div class="answers-form"></div>
  <button type="submit">Submit Answers</button>
</form>

</html>
